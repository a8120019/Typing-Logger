<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
	<!-- 3つのライブラリを読み込む -->
	<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
	<!-- OpenCVを読み込む -->
	<script async src="opencv.js" type="text/javascript"></script>
	<!-- Chart.jsを読み込む -->
	<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1"></script>
	<!-- libを読み込む -->
	<script type="text/javascript" src="lib/jquery.min.js"></script>
	<script type="text/javascript" src="lib/osql.js"></script>

	<script>

		var resultShare;
		var pushList = [];

		// グラフ用の変数
		var keyList = [];
		var timeList = [];


		const config = {
			locateFile: file => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
		};

		const hands = new Hands(config);

		hands.setOptions({
			maxNumHands: 2,
			modelComplexity: 1,
			minDetectionConfidence: 0.5,
			minTrackingConfidence: 0.5
		});

		hands.onResults(onResults);

		// アップロードした画像を表示する関数
		function vidChanger(vid) {

			var file = vid.files[0];

			// filereaderオブジェクト作成 1
			var reader = new FileReader();

			// 読み込み成功時に実行される関数 3
			reader.onload = function (e) {
				// console.log(reader.result);  // ログ出力

				// imgタグの操作
				var vidfile = document.getElementById("video");
				vidfile.src = reader.result;
			}

			// 読み込み開始 2
			reader.readAsDataURL(file);
		}

		function controlVideo() {
			var vidfile = document.getElementById("video");

			if (vidfile.paused) {  // 動画が止まっている場合の処理
				vidfile.play();
				// setInterval(drawCanvas, 1000 / 30);
			} else {  // 動画が動いている場合の処理
				vidfile.pause();
				// clearInterval(drawCanvas);
			}
		}

		// async function drawCanvas() {

		// 	// Log用の関数の用意
		// 	// 左右
		// 	var elements = document.getElementsByName("finger-lr");
		// 	let checkValue = '';

		// 	for (var i = 0; i < elements.length; i++) {
		// 		if (elements.item(i).checked) {
		// 			checkValue = elements.item(i).value;
		// 		}
		// 	}

		// 	iLR = checkValue;

		// 	var video = document.getElementById("video");

		// 	const canvas = document.getElementById("input");
		// 	const ctx = canvas.getContext("2d");

		// 	ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

		// 	await hands.send({ image: canvas });
		// }

		function onResults(results) {
			// console.log(results);
			const canvas = document.getElementById("output");
			const ctx = canvas.getContext("2d");

			ctx.clearRect(0, 0, canvas.width, canvas.height);
			ctx.drawImage(results.image, 0, 0, canvas.width, canvas.height);

			if (results.multiHandLandmarks) {
				for (const marks of results.multiHandLandmarks) {
					// 緑色の線で骨組みを可視化
					drawConnectors(ctx, marks, HAND_CONNECTIONS, { color: '#00ff00' });

					// 赤色でランドマークを可視化
					drawLandmarks(ctx, marks, { color: '#f00' });
				}
			}

			var vidfile = document.getElementById("video");

			resultShare = results;

			if (vidfile.paused == false) {

				// 時間データの入力
				var fnTime = vidfile.currentTime;
				timeList.push(fnTime);

				// 左右感知
				var resultLength = results.multiHandLandmarks.length;
				var checkLR = [];
				if (resultLength == 2) {
					var x_Zero = results.multiHandLandmarks[0][0].x
					var x_One = results.multiHandLandmarks[1][0].x
					if (x_Zero < x_One) {
						checkLR.push("Left");
						checkLR.push("Right");
					} else {
						checkLR.push("Right");
						checkLR.push("Left");
					}
				} else {
					checkLR.push("NONE");
				}

				for (var i = 0; i < 2; i++) {  // 左右のチェック
					if (results.multiHandLandmarks[i]) {

						// 値の入力
						var pushingDict = {};

						for (var j = 0;j < 20;j++) {
							pushingDict[fnTime][j] = results.multiHandLandmarks[i][j].x
						}

						if (checkLR[i] == "Left") {
							leftList.push(pushingDict);
						} else if (checkLR[i] == "Right") {
							rightList.push(pushingDict);
						}
					}
				}
			}
		}

		function resetVideo() {
			clearInterval(drawCanvas);

			var vidfile = document.getElementById("video");

			vidfile.pause();
			vidfile.currentTime = 0;

			pushList = [];
		}

		function selectVideo() {
			var timeNumber = document.getElementById("time").value;
			console.log(timeNumber);
			if (time) {
				var vidfile = document.getElementById("video");

				vidfile.pause();
				vidfile.currentTime = timeNumber;
			}
		}

		function timeVideo() {
			var vidfile = document.getElementById("video");
			console.log(vidfile.currentTime);
		}

		function showResult(index) {
			console.log("--- [result(" + index + ")] ---");
			if (index == 100) {
				console.log(resultShare);
			} else {
				console.log(resultShare.multiHandLandmarks[0][index].z);
			}
		}

		async function keyTimes() {
			// nowTimeに現状の秒数を表示する機能 (setInterval)
			setInterval(showTimes, 1000 / 60);

			// IDのデータ取得
			var keyId = document.getElementById("keyboard-id").value;
			var timeSpace = document.getElementById("space-time").value * 1000;

			var sql = `select * from Logs where sessionid = ${keyId};`;
			var logs = await osql.connect(sql);
			var baseTime = logs[0].time;
			keyList.push("Space");
			timeList.push(Number(document.getElementById("space-time").value));

			// Spaceキーの時間を合わせたデータを変数に保存

			for (var i = 1; i < logs.length; i++) {
				//キー
				keyList.push(logs[i].text);

				// 時間
				var time = Number(logs[i].time) + Number(timeSpace);

				var calcTime = time - baseTime;  // 経過時間の計算
				var sfTime = calcTime / 1000;  // 秒数に変換
				// var msTime = sfTime - Math.floor(sfTime);
				var secondTime = sfTime % 60;  // 秒数表示
				
				timeList.push(Number(secondTime));
			}
		}

		function showTimes() {
			var vidfile = document.getElementById("video");
			var timeNum = vidfile.currentTime;
			document.getElementById("now-time").value = timeNum;
		}

	</script>

</head>

<body>
	<div class="container">
		<!-- テスト動画の表示 -->
		<!-- "https://t.pimg.jp/mp4/018/916/519/1/18916519.mp4" -->
		<video id="video"></video>
		<br>
		<input type="file" id="upload" accept="video/*" onchange="vidChanger(this)">
		<br>
		<center>現在の時間: <span id="now-time">
		<br>
		<span id="previous-key"></span> <button id="previous-button" onclick="buttonPrevious()">前のキー</button> <span id="now-key"></span> <button id="next-button" onclick="buttonNext()">次のキー</button> <span id="next-key"></span>
		</center>
		<br>
		SessionID: <input id="keyboard-id" type="number">
		<br>
		スペースキーを押した時間: <input id="space-time" type="number"> <button id="space-time-decision" onclick="keyTimes()">適用</button>
		<!-- <br> -->
		<!-- <canvas id="input" width="680" height="454"></canvas> -->
		<!--  認識した手の形状を可視化した映像（出力）  -->
		<!-- <canvas id="output" width="680" height="454"></canvas> -->
	</div>
	<hr>
	<h3>Console</h3>
	<br>
	<!-- <button id="videoload" onclick="drawCanvas()">video load</button> -->
	<!-- <br> -->
	<!-- <br> -->
	<button id="start" onclick="controlVideo()">start / stop</button>
	<button id="stop" onclick="resetVideo()">reset</button>
	<br>
	<input type="number" id="time">
	<button id="select" onclick="selectVideo()">select</button>
	<br>
	<button id="stop" onclick="timeVideo()">time check</button>
	<hr>
</body>

</html>